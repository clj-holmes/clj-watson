(ns clj-watson.logic.github.vulnerability
  (:require
   [clj-watson.logic.dependency :as logic.dependency]
   [clj-watson.logic.version :as version]
   [clojure.string :as string]))

(def ^:private operators
  {">"  version/newer?
   ">=" version/newer-or-equal?
   "<"  version/older?
   "="  =
   "<=" version/older-or-equal?})

(defn is-version-vulnerable? [version {:keys [vulnerableVersionRange]}]
  (let [version (logic.dependency/get-dependency-version version)
        validate-fn (->> (string/split vulnerableVersionRange #",")
                         (map string/trim)
                         (map #(string/split % #"\s"))
                         (map (fn [[op vulnerability-version]]
                                #((get operators op) % vulnerability-version)))
                         (apply juxt))]
    (every? true? (validate-fn version))))

(defn version-not-vulnerable [vulnerabilities]
  (->> vulnerabilities
       (map (comp :identifier :firstPatchedVersion))
       (filter identity)
       (sort version/version-compare)
       last))

