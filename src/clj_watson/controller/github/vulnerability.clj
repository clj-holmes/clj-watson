(ns clj-watson.controller.github.vulnerability
  (:require
   [clj-watson.diplomat.dependency :as diplomat.dependency]
   [clj-watson.diplomat.github.advisory :as diplomat.gh.advisory]
   [clj-watson.logic.github.vulnerability :as logic.gh.vulnerability]
   [clj-watson.logic.rules.allowlist :as logic.rules.allowlist]
   [clojure.string :as str])
  (:import
   (java.time ZoneOffset ZonedDateTime)))

(def ^:private dependency-rename
  {'org.jdom/jdom2 'org.jdom/jdom})

(defn ^:private latest-dependency-version
  [dependency all-dependency-vulnerabilities repositories]
  (let [latest-version (diplomat.dependency/get-latest-version! dependency repositories)
        vulnerabilities (filterv (partial logic.gh.vulnerability/is-version-vulnerable? latest-version) all-dependency-vulnerabilities)]
    (when (not (seq vulnerabilities))
      latest-version)))

(defn ^:private enrich
  "Normalize and enrich the response from GitHub.

  - Normalize MODERATE `severity` to MEDIUM
  - Extract CVSS version from `vectorString`"
  [{:keys [advisory] :as vulnerability}]
  (let [{:keys [cvss severity]} advisory
        {:keys [vectorString]} cvss
        cvss-version (when vectorString
                       (second (re-find #"^CVSS:(.*?)/" vectorString)))]
    (cond-> vulnerability
      (= "MODERATE" (str/upper-case severity))
      (assoc-in [:advisory :severity] "MEDIUM")

      cvss-version
      (assoc-in [:advisory :cvss :version] cvss-version)

      :always ;; we don't currently include vectorString in our findings
      (update-in [:advisory :cvss] dissoc :vectorString))))

(comment
  (re-find #"^CVSS:(.*?)/" "CVSS:3.1/AV:N/AC:H/PR:L/UI:R/S:U/C:H/I:H/A:H")
  ;; => ["CVSS:3.1/" "3.1"]

  :eoc)

(defn ^:private scan-dependency
  [repositories allow-list {:keys [dependency] :as dependency-info}]
  (let [dependency-name-for-github (or (get dependency-rename dependency) dependency)
        all-dependency-vulnerabilities (diplomat.gh.advisory/vulnerabilities-by-package dependency-name-for-github)
        reported-vulnerabilities (filterv (partial logic.gh.vulnerability/is-version-vulnerable? dependency-info) all-dependency-vulnerabilities)
        ; not sure how to use it here and avoid always recommend the latest version (logic.gh.vulnerability/version-not-vulnerable all-dependency-vulnerabilities)
        filtered-vulnerabilities (remove (partial logic.rules.allowlist/by-pass? allow-list (ZonedDateTime/now ZoneOffset/UTC)) reported-vulnerabilities)
        enriched-vulnerabilities (mapv enrich filtered-vulnerabilities)
        latest-secure-version (latest-dependency-version dependency all-dependency-vulnerabilities repositories)]
    (if (seq enriched-vulnerabilities)
      (assoc dependency-info :vulnerabilities enriched-vulnerabilities :secure-version latest-secure-version)
      dependency-info)))

(defn scan-dependencies
  [dependencies repositories allow-list]
  (->> dependencies
       (pmap (partial scan-dependency repositories allow-list))
       (filterv :vulnerabilities)))

(comment
  (def repositories {:mvn/repos {"central" {:url "https://repo1.maven.org/maven2/"}
                                 "clojars" {:url "https://repo.clojars.org/"}}})

  ;; assumes GITHUB_TOKEN is set in your REPL env
  (scan-dependencies [{:dependency 'org.apache.commons/commons-compress :mvn/version "1.21"}] repositories {})

  (scan-dependencies [{:dependency 'org.postgresql/postgresql :mvn/version "42.2.10"}] repositories {})

  :eoc)
