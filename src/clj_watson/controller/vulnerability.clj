(ns clj-watson.controller.vulnerability
  (:require [clj-watson.logic.vulnerability :as logic.vulnerability]
            [clj-watson.diplomat.dependency :as diplomat.dependency]
            [clj-watson.diplomat.github :as diplomat.github]))

(defn ^:private scan-dependency [{:keys [dependency mvn/version] :as dependency-info} deps]
  (let [all-package-vulnerabilities (diplomat.github/vulnerabilities-by-package dependency)
        filtered-vulnerabilities (filterv #(logic.vulnerability/is-version-vulnerable? version %) all-package-vulnerabilities)
        repositories (select-keys [:mvn/version] deps)
        latest-secure-version (or (logic.vulnerability/latest-version-not-vulnerable all-package-vulnerabilities)
                                  (last (diplomat.dependency/get-all-versions! dependency repositories)))]
    (if (seq filtered-vulnerabilities)
      (assoc dependency-info :vulnerabilities filtered-vulnerabilities :secure-version latest-secure-version)
      dependency-info)))

(defn scan-dependencies [dependencies deps]
  (->> dependencies
       (pmap #(scan-dependency % deps))
       (filterv :vulnerabilities)))

(comment
  (scan-dependencies [{:dependency  'org.clojure/clojure
                       :mvn/version "1.9.0"}]
                     nil)

  (scan-dependencies [{:dependency  'org.postgresql/postgresql
                       :mvn/version "42.2.10"}]
                     nil))